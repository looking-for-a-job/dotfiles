#!/usr/bin/env python
# -*- coding: utf-8 -*-
import my_tasks
import task_timeout_10m
from task.models import Task

"""
перерыв на 20 секунд каждые 15 минут
ЕСЛИ юзер не afk и если 15 минут он был не afk
"""


class Timeout_20s(my_tasks.Now):
    name = "Перерыв для глаз 20 секунд"

    def todo(self):
        if self.elapsed and self.elapsed < 15*60:
            return False
        if self.shell("afk") > 120:
            return False
        timeout_10m = task_timeout_10m.Timeout_10m()
        if timeout_10m.todo() or (timeout_10m.completed_at and timeout_10m.elapsed < 15*60):
            return False
        if self.psql('SELECT COUNT(*) FROM last_30minutes WHERE available=true',"afk")<20:
            return
        if self.psql('SELECT COUNT(*) FROM last_15minutes WHERE min_afk>60',"afk")>3:
            return
        if self.psql('SELECT COUNT(*) FROM last_15minutes WHERE max_afk<60',"afk") < 10:
            return
        if self.psql('SELECT COUNT(*) FROM last_5minutes WHERE max_afk<60',"afk") < 3:
            return
        return True

if __name__ == "__main__":
    print(Task.objects.get(class_name=Timeout_20s.__name__))
